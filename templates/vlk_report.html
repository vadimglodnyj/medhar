<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>–†–∞–ø–æ—Ä—Ç –í–õ–ö</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 10px;
      }
      label {
        display: block;
        margin-top: 15px;
        font-weight: bold;
      }
      input[type="text"],
      select,
      textarea {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        box-sizing: border-box;
      }
      textarea {
        height: 100px;
        resize: vertical;
      }
      input[type="submit"] {
        margin-top: 25px;
        padding: 10px 20px;
        background-color: #dc3545;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }
      input[type="submit"]:disabled {
        background-color: #5a9cec;
        cursor: not-allowed;
      }
      .loader-overlay {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #dc3545;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
      }
      .loader-text {
        margin-top: 20px;
        color: #333;
        font-size: 18px;
        font-weight: bold;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* –°—Ç–∏–ª—ñ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª—ñ—Ç—É */
      .autocomplete-container {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .autocomplete-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .autocomplete-suggestion:hover,
      .autocomplete-suggestion.selected {
        background-color: #f0f0f0;
      }

      .autocomplete-suggestion:last-child {
        border-bottom: none;
      }

      /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
      .alert {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }

      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #dc3545;
        text-decoration: none;
        font-weight: bold;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .form-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }

      .form-section h3 {
        margin-top: 0;
        color: #495057;
      }

      .document-fields {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="loader" class="loader-overlay" style="display: none">
      <div class="spinner"></div>
      <div class="loader-text">
        –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä–∞–ø–æ—Ä—Ç—É –í–õ–ö... –ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞.
      </div>
    </div>

    <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –¥–æ –≥–æ–ª–æ–≤–Ω–æ—ó</a>
    <h1>ü©∫ –†–∞–ø–æ—Ä—Ç –í–õ–ö</h1>

    <!-- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å -->
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div
      class="alert alert-{{ 'error' if category == 'error' else 'success' }}"
    >
      {{ message }}
    </div>
    {% endfor %} {% endif %} {% endwith %}

    <form id="generation-form" method="POST">
      <div class="form-section">
        <h3>üë§ –û—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ</h3>

        <label for="pib_nazivnyi">–ü–Ü–ë (–≤ –Ω–∞–∑–∏–≤–Ω–æ–º—É –≤—ñ–¥–º—ñ–Ω–∫—É):</label>
        <div class="autocomplete-container">
          <input
            type="text"
            id="pib_nazivnyi"
            name="pib_nazivnyi"
            placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –ü–Ü–ë –¥–ª—è –ø–æ—à—É–∫—É..."
            required
          />
          <div id="pib-suggestions" class="autocomplete-suggestions"></div>
        </div>

        <label for="soldier_rank_rodovuy">–ó–≤–∞–Ω–Ω—è (–≤ —Ä–æ–¥–æ–≤–æ–º—É –≤—ñ–¥–º—ñ–Ω–∫—É):</label>
        <input
          type="text"
          id="soldier_rank_rodovuy"
          name="soldier_rank_rodovuy"
          placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: —Å–æ–ª–¥–∞—Ç–∞"
        />

        <label for="soldier_full_name_rodovuy"
          >–ü–Ü–ë (–≤ —Ä–æ–¥–æ–≤–æ–º—É –≤—ñ–¥–º—ñ–Ω–∫—É):</label
        >
        <input
          type="text"
          id="soldier_full_name_rodovuy"
          name="soldier_full_name_rodovuy"
          placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –Ü–≤–∞–Ω–æ–≤–∞ –Ü–≤–∞–Ω–∞ –Ü–≤–∞–Ω–æ–≤–∏—á–∞"
          required
        />

        <label for="birth_date">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è:</label>
        <input
          type="text"
          id="birth_date"
          name="birth_date"
          placeholder="–¥–¥.–º–º.—Ä—Ä—Ä—Ä"
          pattern="\d{2}\.\d{2}\.\d{4}"
          title="–í–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º.—Ä—Ä—Ä—Ä"
        />
      </div>

      <div class="form-section">
        <h3>üéñÔ∏è –í—ñ–π—Å—å–∫–æ–≤—ñ –¥–∞–Ω—ñ</h3>

        <label for="zvanie">–í—ñ–π—Å—å–∫–æ–≤–µ –∑–≤–∞–Ω–Ω—è:</label>
        <select id="zvanie" name="zvanie" required>
          <option value="">–û–±–µ—Ä—ñ—Ç—å –∑–≤–∞–Ω–Ω—è</option>
          <option value="—Å–æ–ª–¥–∞—Ç">—Å–æ–ª–¥–∞—Ç</option>
          <option value="—Å—Ç–∞—Ä—à–∏–π —Å–æ–ª–¥–∞—Ç">—Å—Ç–∞—Ä—à–∏–π —Å–æ–ª–¥–∞—Ç</option>
          <option value="–º–æ–ª–æ–¥—à–∏–π —Å–µ—Ä–∂–∞–Ω—Ç">–º–æ–ª–æ–¥—à–∏–π —Å–µ—Ä–∂–∞–Ω—Ç</option>
          <option value="—Å–µ—Ä–∂–∞–Ω—Ç">—Å–µ—Ä–∂–∞–Ω—Ç</option>
          <option value="—Å—Ç–∞—Ä—à–∏–π —Å–µ—Ä–∂–∞–Ω—Ç">—Å—Ç–∞—Ä—à–∏–π —Å–µ—Ä–∂–∞–Ω—Ç</option>
          <option value="–≥–æ–ª–æ–≤–Ω–∏–π —Å–µ—Ä–∂–∞–Ω—Ç">–≥–æ–ª–æ–≤–Ω–∏–π —Å–µ—Ä–∂–∞–Ω—Ç</option>
          <option value="—à—Ç–∞–±-—Å–µ—Ä–∂–∞–Ω—Ç">—à—Ç–∞–±-—Å–µ—Ä–∂–∞–Ω—Ç</option>
          <option value="–º–∞–π—Å—Ç–µ—Ä-—Å–µ—Ä–∂–∞–Ω—Ç">–º–∞–π—Å—Ç–µ—Ä-—Å–µ—Ä–∂–∞–Ω—Ç</option>
          <option value="—Å—Ç–∞—Ä—à–∏–π –º–∞–π—Å—Ç–µ—Ä-—Å–µ—Ä–∂–∞–Ω—Ç">
            —Å—Ç–∞—Ä—à–∏–π –º–∞–π—Å—Ç–µ—Ä-—Å–µ—Ä–∂–∞–Ω—Ç
          </option>
          <option value="–≥–æ–ª–æ–≤–Ω–∏–π –º–∞–π—Å—Ç–µ—Ä-—Å–µ—Ä–∂–∞–Ω—Ç">
            –≥–æ–ª–æ–≤–Ω–∏–π –º–∞–π—Å—Ç–µ—Ä-—Å–µ—Ä–∂–∞–Ω—Ç
          </option>
          <option value="–º–æ–ª–æ–¥—à–∏–π –ª–µ–π—Ç–µ–Ω–∞–Ω—Ç">–º–æ–ª–æ–¥—à–∏–π –ª–µ–π—Ç–µ–Ω–∞–Ω—Ç</option>
          <option value="–ª–µ–π—Ç–µ–Ω–∞–Ω—Ç">–ª–µ–π—Ç–µ–Ω–∞–Ω—Ç</option>
          <option value="—Å—Ç–∞—Ä—à–∏–π –ª–µ–π—Ç–µ–Ω–∞–Ω—Ç">—Å—Ç–∞—Ä—à–∏–π –ª–µ–π—Ç–µ–Ω–∞–Ω—Ç</option>
          <option value="–∫–∞–ø—ñ—Ç–∞–Ω">–∫–∞–ø—ñ—Ç–∞–Ω</option>
          <option value="–º–∞–π–æ—Ä">–º–∞–π–æ—Ä</option>
          <option value="–ø—ñ–¥–ø–æ–ª–∫–æ–≤–Ω–∏–∫">–ø—ñ–¥–ø–æ–ª–∫–æ–≤–Ω–∏–∫</option>
          <option value="–ø–æ–ª–∫–æ–≤–Ω–∏–∫">–ø–æ–ª–∫–æ–≤–Ω–∏–∫</option>
        </select>

        <label for="sluzhba_type">–í–∏–¥ —Å–ª—É–∂–±–∏:</label>
        <select id="sluzhba_type" name="sluzhba_type">
          <option value="–ø—ñ–¥ —á–∞—Å –º–æ–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó">–ø—ñ–¥ —á–∞—Å –º–æ–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó</option>
          <option value="–∑–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º">–∑–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º</option>
        </select>

        <label for="enlistment_date">–î–∞—Ç–∞ –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –≤ —Å–ø–∏—Å–∫–∏ —á–∞—Å—Ç–∏–Ω–∏:</label>
        <select
          id="enlistment_date"
          name="enlistment_date"
          required
          onchange="toggleCustomDate()"
        >
          <option value="">–û–±–µ—Ä—ñ—Ç—å –≤–∞—Ä—ñ–∞–Ω—Ç</option>
          <option value="–∑ –º–æ–º–µ–Ω—Ç—É –ø—Ä–∏–∑–æ–≤—É">–ó –º–æ–º–µ–Ω—Ç—É –ø—Ä–∏–∑–æ–≤—É</option>
          <option value="custom">–í–∫–∞–∑–∞—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –¥–∞—Ç—É</option>
        </select>
        <input
          type="text"
          id="enlistment_date_custom"
          name="enlistment_date_custom"
          placeholder="–¥–¥.–º–º.—Ä—Ä—Ä—Ä"
          pattern="\d{2}\.\d{2}\.\d{4}"
          title="–í–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º.—Ä—Ä—Ä—Ä"
          style="display: none; margin-top: 10px"
        />
      </div>

      <div class="form-section">
        <h3>‚ÑπÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
        <p style="color: #666; font-style: italic">
          –î–∞–Ω—ñ –∫–æ–º–∞–Ω–¥–∏—Ä—ñ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö Commanders.
        </p>
      </div>

      <div class="form-section">
        <h3>üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∏ –¥–æ —Ä–∞–ø–æ—Ä—Ç—É</h3>

        <label for="document_type">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
        <select
          id="document_type"
          name="document_type"
          required
          onchange="toggleDocumentFields()"
        >
          <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</option>
          <option value="examination_result">–ö–æ–ø—ñ—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –æ–≥–ª—è–¥—É</option>
          <option value="discharge_epicrisis">–ö–æ–ø—ñ—é –≤–∏–ø–∏—Å–Ω–æ–≥–æ –µ–ø—ñ–∫—Ä–∏–∑—É</option>
          <option value="vlk_decision">–ö–æ–ø—ñ—é —Ä—ñ—à–µ–Ω–Ω—è –í–õ–ö</option>
        </select>

        <!-- –ü–æ–ª—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –æ–≥–ª—è–¥—É -->
        <div
          id="examination_fields"
          class="document-fields"
          style="display: none"
        >
          <label for="examination_number">–ù–æ–º–µ—Ä –æ–≥–ª—è–¥—É:</label>
          <input
            type="text"
            id="examination_number"
            name="examination_number"
            placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 2025-0818-1144-0832-7"
          />

          <label for="doctor_specialty">–°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å –ª—ñ–∫–∞—Ä—è:</label>
          <select id="doctor_specialty" name="doctor_specialty">
            <option value="">–û–±–µ—Ä—ñ—Ç—å —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å</option>
            <option value="–ª—ñ–∫–∞—Ä—è-–æ—Ä—Ç–æ–ø–µ–¥–∞-—Ç—Ä–∞–≤–º–∞—Ç–æ–ª–æ–≥–∞">
              –ª—ñ–∫–∞—Ä—è-–æ—Ä—Ç–æ–ø–µ–¥–∞-—Ç—Ä–∞–≤–º–∞—Ç–æ–ª–æ–≥–∞
            </option>
            <option value="–ª—ñ–∫–∞—Ä—è-—Ö—ñ—Ä—É—Ä–≥–∞">–ª—ñ–∫–∞—Ä—è-—Ö—ñ—Ä—É—Ä–≥–∞</option>
            <option value="–ª—ñ–∫–∞—Ä—è-—Ç–µ—Ä–∞–ø–µ–≤—Ç–∞">–ª—ñ–∫–∞—Ä—è-—Ç–µ—Ä–∞–ø–µ–≤—Ç–∞</option>
            <option value="–ª—ñ–∫–∞—Ä—è-–Ω–µ–≤—Ä–æ–ª–æ–≥–∞">–ª—ñ–∫–∞—Ä—è-–Ω–µ–≤—Ä–æ–ª–æ–≥–∞</option>
            <option value="–ª—ñ–∫–∞—Ä—è-–∫–∞—Ä–¥—ñ–æ–ª–æ–≥–∞">–ª—ñ–∫–∞—Ä—è-–∫–∞—Ä–¥—ñ–æ–ª–æ–≥–∞</option>
            <option value="–ª—ñ–∫–∞—Ä—è-–æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∞">–ª—ñ–∫–∞—Ä—è-–æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥–∞</option>
            <option value="–ª—ñ–∫–∞—Ä—è-–æ—Ç–æ–ª–∞—Ä–∏–Ω–≥–æ–ª–æ–≥–∞">–ª—ñ–∫–∞—Ä—è-–æ—Ç–æ–ª–∞—Ä–∏–Ω–≥–æ–ª–æ–≥–∞</option>
            <option value="–ª—ñ–∫–∞—Ä—è-–ø—Å–∏—Ö—ñ–∞—Ç—Ä–∞">–ª—ñ–∫–∞—Ä—è-–ø—Å–∏—Ö—ñ–∞—Ç—Ä–∞</option>
            <option value="–ª—ñ–∫–∞—Ä—è-–µ–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∞">–ª—ñ–∫–∞—Ä—è-–µ–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∞</option>
            <option value="–ª—ñ–∫–∞—Ä—è-–≥–∞—Å—Ç—Ä–æ–µ–Ω—Ç–µ—Ä–æ–ª–æ–≥–∞">
              –ª—ñ–∫–∞—Ä—è-–≥–∞—Å—Ç—Ä–æ–µ–Ω—Ç–µ—Ä–æ–ª–æ–≥–∞
            </option>
          </select>

          <label for="doctor_name">–ü–Ü–ë –ª—ñ–∫–∞—Ä—è:</label>
          <input
            type="text"
            id="doctor_name"
            name="doctor_name"
            placeholder="–ü–Ü–ë –ª—ñ–∫–∞—Ä—è"
          />
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è –≤–∏–ø–∏—Å–Ω–æ–≥–æ –µ–ø—ñ–∫—Ä–∏–∑—É -->
        <div
          id="epicrisis_fields"
          class="document-fields"
          style="display: none"
        >
          <label for="epicrisis_number">–ù–æ–º–µ—Ä –≤–∏–ø–∏—Å–Ω–æ–≥–æ –µ–ø—ñ–∫—Ä–∏–∑—É:</label>
          <input
            type="text"
            id="epicrisis_number"
            name="epicrisis_number"
            placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 2025-0818-1144-0832-7"
          />
        </div>

        <!-- –ü–æ–ª—è –¥–ª—è —Ä—ñ—à–µ–Ω–Ω—è –í–õ–ö -->
        <div
          id="vlk_decision_fields"
          class="document-fields"
          style="display: none"
        >
          <label for="vlk_decision_number">–ù–æ–º–µ—Ä —Ä—ñ—à–µ–Ω–Ω—è –í–õ–ö:</label>
          <input
            type="text"
            id="vlk_decision_number"
            name="vlk_decision_number"
            placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 2025-0818-1144-0832-7"
          />
        </div>

        <!-- –ó–∞–≥–∞–ª—å–Ω—ñ –ø–æ–ª—è –¥–ª—è –≤—Å—ñ—Ö —Ç–∏–ø—ñ–≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ -->
        <label for="document_date">–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</label>
        <input
          type="text"
          id="document_date"
          name="document_date"
          placeholder="–¥–¥.–º–º.—Ä—Ä—Ä—Ä"
          pattern="\d{2}\.\d{2}\.\d{4}"
          title="–í–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º.—Ä—Ä—Ä—Ä"
          required
        />

        <label for="document_issuer">–î–µ –æ—Ç—Ä–∏–º–∞–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç:</label>
        <input
          type="text"
          id="document_issuer"
          name="document_issuer"
          placeholder="–ù–∞–∑–≤–∞ –∑–∞–∫–ª–∞–¥—É"
          value='–î–£ "–¢–ú–û –ú–í–° –£–∫—Ä–∞—ó–Ω–∏ –ø–æ –ó–∞–ø–æ—Ä—ñ–∑—å–∫—ñ–π –æ–±–ª–∞—Å—Ç—ñ"'
        />
      </div>

      <input id="submit-button" type="submit" value="–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–∞–ø–æ—Ä—Ç –í–õ–ö" />
    </form>

    <script>
      const form = document.getElementById("generation-form");
      const submitButton = document.getElementById("submit-button");
      const loader = document.getElementById("loader");
      const pibNazivnyi = document.getElementById("pib_nazivnyi");
      const pibRodovyi = document.getElementById("pib_rodovyi");
      const pibSuggestions = document.getElementById("pib-suggestions");

      let currentSuggestions = [];
      let selectedIndex = -1;

      function getCookie(name) {
        let a = `; ${document.cookie}`.match(`;\\s*${name}=([^;]+)`);
        return a ? a[1] : "";
      }

      // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ—à—É–∫—É –ü–Ü–ë
      async function searchPIB(query) {
        if (query.length < 2) {
          hideSuggestions();
          return;
        }

        try {
          const response = await fetch(
            `/api/search_pib?q=${encodeURIComponent(query)}`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.results && data.results.length > 0) {
            showSuggestions(data.results);
          } else {
            hideSuggestions();
          }
        } catch (error) {
          console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ—à—É–∫—É –ü–Ü–ë:", error);
          hideSuggestions();
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó
      function showSuggestions(suggestions) {
        currentSuggestions = suggestions;
        selectedIndex = -1;

        pibSuggestions.innerHTML = "";

        suggestions.forEach((suggestion, index) => {
          const div = document.createElement("div");
          div.className = "autocomplete-suggestion";
          div.textContent = suggestion.label;
          div.dataset.value = suggestion.value;
          div.dataset.index = index;

          div.addEventListener("click", function () {
            selectSuggestion(suggestion);
          });

          pibSuggestions.appendChild(div);
        });

        pibSuggestions.style.display = "block";
      }

      // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó
      function hideSuggestions() {
        pibSuggestions.style.display = "none";
        currentSuggestions = [];
        selectedIndex = -1;
      }

      // –í–∏–±—Ä–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é
      function selectSuggestion(suggestion) {
        const value =
          typeof suggestion === "string" ? suggestion : suggestion.value;
        const data = typeof suggestion === "object" ? suggestion : null;

        pibNazivnyi.value = value;

        // –û—á–∏—â–∞—î–º–æ –ø–æ–ª–µ —Ä–æ–¥–æ–≤–æ–≥–æ –≤—ñ–¥–º—ñ–Ω–∫—É
        pibRodovyi.value = "";

        // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –∑–≤–∞–Ω–Ω—è —Ç–∞ –¥–∞—Ç–∏ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è —è–∫—â–æ —î –¥–∞–Ω—ñ
        if (data && data.rank) {
          const rankSelect = document.getElementById("zvanie");
          if (rankSelect) {
            // –®—É–∫–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–µ –∑–≤–∞–Ω–Ω—è –≤ —Å–µ–ª–µ–∫—Ç—ñ
            for (let option of rankSelect.options) {
              if (option.value.toLowerCase() === data.rank.toLowerCase()) {
                rankSelect.value = option.value;
                break;
              }
            }
          }
        }

        if (data && data.birth_date) {
          const birthDateInput = document.getElementById("birth_date");
          if (birthDateInput && !birthDateInput.value) {
            // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç –¥–¥.–º–º.—Ä—Ä—Ä—Ä
            try {
              const date = new Date(data.birth_date);
              if (!isNaN(date.getTime())) {
                const day = String(date.getDate()).padStart(2, "0");
                const month = String(date.getMonth() + 1).padStart(2, "0");
                const year = date.getFullYear();
                birthDateInput.value = `${day}.${month}.${year}`;
              }
            } catch (e) {
              console.log("–ù–µ –≤–¥–∞–ª–æ—Å—è –∫–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è");
            }
          }
        }

        hideSuggestions();
      }

      // –û–±—Ä–æ–±–∫–∞ –∫–ª–∞–≤—ñ—à –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
      function handleKeyNavigation(e) {
        if (pibSuggestions.style.display === "none") return;

        const suggestions = pibSuggestions.querySelectorAll(
          ".autocomplete-suggestion"
        );

        switch (e.key) {
          case "ArrowDown":
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
            updateSelection(suggestions);
            break;
          case "ArrowUp":
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(suggestions);
            break;
          case "Enter":
            e.preventDefault();
            if (selectedIndex >= 0 && suggestions[selectedIndex]) {
              const suggestionData = currentSuggestions[selectedIndex];
              selectSuggestion(suggestionData);
            }
            break;
          case "Escape":
            hideSuggestions();
            break;
        }
      }

      // –û–Ω–æ–≤–∏—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
      function updateSelection(suggestions) {
        suggestions.forEach((suggestion, index) => {
          suggestion.classList.toggle("selected", index === selectedIndex);
        });
      }

      // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞—Ç–∏
      function validateDate(dateString) {
        const pattern = /^(\d{2})\.(\d{2})\.(\d{4})$/;
        const match = dateString.match(pattern);
        if (!match) return false;

        const day = parseInt(match[1], 10);
        const month = parseInt(match[2], 10);
        const year = parseInt(match[3], 10);

        if (month < 1 || month > 12) return false;
        if (day < 1 || day > 31) return false;
        if (year < 1900 || year > new Date().getFullYear()) return false;

        const date = new Date(year, month - 1, day);
        return (
          date.getDate() === day &&
          date.getMonth() === month - 1 &&
          date.getFullYear() === year
        );
      }

      // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø–æ–ª—ñ–≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤
      function toggleDocumentFields() {
        const documentType = document.getElementById("document_type").value;

        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –ø–æ–ª—è
        document.getElementById("examination_fields").style.display = "none";
        document.getElementById("epicrisis_fields").style.display = "none";
        document.getElementById("vlk_decision_fields").style.display = "none";

        // –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –ø–æ–ª—è
        if (documentType === "examination_result") {
          document.getElementById("examination_fields").style.display = "block";
        } else if (documentType === "discharge_epicrisis") {
          document.getElementById("epicrisis_fields").style.display = "block";
        } else if (documentType === "vlk_decision") {
          document.getElementById("vlk_decision_fields").style.display =
            "block";
        }
      }

      // –ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ä–æ–¥–æ–≤–æ–≥–æ –≤—ñ–¥–º—ñ–Ω–∫—É —Ç–∞ –ø–æ—à—É–∫ –ü–Ü–ë
      let searchTimeout;

      pibNazivnyi.addEventListener("input", function () {
        // –û—á–∏—â–∞—î–º–æ –ø–æ–ª–µ —Ä–æ–¥–æ–≤–æ–≥–æ –≤—ñ–¥–º—ñ–Ω–∫—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ –ü–Ü–ë
        pibRodovyi.value = "";

        // –ü–æ—à—É–∫ –ü–Ü–ë –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchPIB(pibNazivnyi.value);
        }, 300);
      });

      // –û–±—Ä–æ–±–∫–∞ –∫–ª–∞–≤—ñ—à –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
      pibNazivnyi.addEventListener("keydown", handleKeyNavigation);

      // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –ø–æ–ª–µ–º
      document.addEventListener("click", function (e) {
        if (
          !pibNazivnyi.contains(e.target) &&
          !pibSuggestions.contains(e.target)
        ) {
          hideSuggestions();
        }
      });

      // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–æ–ª—è –¥–∞—Ç–∏ –ø—Ä–∏–∑–æ–≤—É (select)
      document
        .getElementById("enlistment_date")
        .addEventListener("change", function () {
          if (!this.value) {
            this.setCustomValidity("–û–±–µ—Ä—ñ—Ç—å –≤–∞—Ä—ñ–∞–Ω—Ç –¥–∞—Ç–∏ –ø—Ä–∏–∑–æ–≤—É");
          } else if (
            this.value === "–∑ –º–æ–º–µ–Ω—Ç—É –ø—Ä–∏–∑–æ–≤—É" ||
            this.value === "custom"
          ) {
            this.setCustomValidity("");
          } else {
            this.setCustomValidity("–û–±–µ—Ä—ñ—Ç—å –≤–∞–ª—ñ–¥–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç");
          }
        });

      document
        .getElementById("birth_date")
        .addEventListener("blur", function () {
          if (this.value && !validateDate(this.value)) {
            this.setCustomValidity(
              "–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º.—Ä—Ä—Ä—Ä"
            );
          } else {
            this.setCustomValidity("");
          }
        });

      document
        .getElementById("document_date")
        .addEventListener("blur", function () {
          if (this.value && !validateDate(this.value)) {
            this.setCustomValidity(
              "–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º.—Ä—Ä—Ä—Ä"
            );
          } else {
            this.setCustomValidity("");
          }
        });

      // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–ª—è –ø–æ–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ—ó –¥–∞—Ç–∏ –ø—Ä–∏–∑–æ–≤—É
      document
        .getElementById("enlistment_date_custom")
        .addEventListener("blur", function () {
          if (this.value && !validateDate(this.value)) {
            this.setCustomValidity(
              "–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ –¥–¥.–º–º.—Ä—Ä—Ä—Ä"
            );
          } else {
            this.setCustomValidity("");
          }
        });

      form.addEventListener("submit", function () {
        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–ª—è –ø–æ–ª—è –¥–∞—Ç–∏ –ø—Ä–∏–∑–æ–≤—É
        const enlistmentSelect = document.getElementById("enlistment_date");
        const customInput = document.getElementById("enlistment_date_custom");

        if (enlistmentSelect.value === "custom" && !customInput.value) {
          customInput.setCustomValidity("–í–∫–∞–∂—ñ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –¥–∞—Ç—É");
          customInput.reportValidity();
          return false;
        }

        if (form.checkValidity()) {
          loader.style.display = "flex";
          submitButton.disabled = true;

          let cookieCheck = setInterval(function () {
            if (getCookie("fileDownload") === "true") {
              clearInterval(cookieCheck);
              loader.style.display = "none";
              submitButton.disabled = false;
              document.cookie =
                "fileDownload=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            }
          }, 500);
        }
      });

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
      document.addEventListener("DOMContentLoaded", function () {
        const enlistmentSelect = document.getElementById("enlistment_date");
        if (enlistmentSelect.value) {
          toggleCustomDate();
        }
      });

      // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –º—ñ–∂ –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏ –¥–∞—Ç–∏ –ø—Ä–∏–∑–æ–≤—É
      function toggleCustomDate() {
        const select = document.getElementById("enlistment_date");
        const customInput = document.getElementById("enlistment_date_custom");

        if (select.value === "custom") {
          customInput.style.display = "block";
          customInput.required = true;
          // –û—á–∏—â–∞—î–º–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é select, –æ—Å–∫—ñ–ª—å–∫–∏ —Ç–µ–ø–µ—Ä –ø–æ—Ç—Ä—ñ–±–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è custom –ø–æ–ª—è
          select.setCustomValidity("");
        } else {
          customInput.style.display = "none";
          customInput.required = false;
          customInput.value = "";
          customInput.setCustomValidity("");
          // –í–∞–ª—ñ–¥—É—î–º–æ select
          if (!select.value) {
            select.setCustomValidity("–û–±–µ—Ä—ñ—Ç—å –≤–∞—Ä—ñ–∞–Ω—Ç –¥–∞—Ç–∏ –ø—Ä–∏–∑–æ–≤—É");
          } else if (
            select.value === "–∑ –º–æ–º–µ–Ω—Ç—É –ø—Ä–∏–∑–æ–≤—É" ||
            select.value === "custom"
          ) {
            select.setCustomValidity("");
          } else {
            select.setCustomValidity("–û–±–µ—Ä—ñ—Ç—å –≤–∞–ª—ñ–¥–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç");
          }
        }
      }
    </script>
  </body>
</html>
