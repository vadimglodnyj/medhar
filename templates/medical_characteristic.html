{% extends "base.html" %} {% block title %}Медична характеристика - МедХар{%
endblock %} {% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="page-header text-center">
        <h1><i class="fas fa-file-medical me-3"></i>Медична характеристика</h1>
        <p class="lead">Генерація медичної характеристики військовослужбовця</p>
      </div>

      <!-- Статистика бази даних -->
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">
            <i class="fas fa-database me-2"></i>Статистика бази даних
          </h6>
        </div>
        <div class="card-body">
          <p class="mb-0">
            <strong>База даних:</strong>
            <span id="stats-text">Завантаження...</span>
          </p>
        </div>
      </div>

      <!-- Відображення повідомлень -->
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <!-- Форма генерації -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-edit me-2"></i>Заповніть дані для генерації
          </h5>
        </div>
        <div class="card-body">
          <form id="generation-form" method="POST">
            <!-- ПІБ в називному відмінку -->
            <div class="mb-3">
              <label for="pib_nazivnyi" class="form-label">
                <i class="fas fa-user me-1"></i>ПІБ (в називному відмінку)
              </label>
              <div class="autocomplete-container">
                <input
                  type="text"
                  id="pib_nazivnyi"
                  name="pib_nazivnyi"
                  class="form-control"
                  placeholder="Почніть вводити ПІБ для пошуку..."
                  required
                />
                <div
                  id="pib-suggestions"
                  class="autocomplete-suggestions"
                ></div>
              </div>
            </div>

            <!-- ПІБ в родовому відмінку -->
            <div class="mb-3">
              <label for="pib_rodovyi" class="form-label">
                <i class="fas fa-user-tag me-1"></i>ПІБ (в родовому відмінку)
              </label>
              <input
                type="text"
                id="pib_rodovyi"
                name="pib_rodovyi"
                class="form-control"
                placeholder="Прізвища Імені По батькові"
                required
              />
              <div class="form-text text-danger">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>УВАГА:</strong> Введіть ПІБ в родовому відмінку вручну
                (наприклад: Іванова Івана Івановича)
              </div>
            </div>

            <!-- Дата зарахування -->
            <div class="mb-3">
              <label for="enlistment_date" class="form-label">
                <i class="fas fa-calendar-plus me-1"></i>Дата зарахування в
                списки частини
              </label>
              <select
                id="enlistment_date"
                name="enlistment_date"
                class="form-select"
                required
                onchange="toggleCustomDate()"
              >
                <option value="">Оберіть варіант</option>
                <option value="з моменту призову">З моменту призову</option>
                <option value="custom">Вказати конкретну дату</option>
              </select>
              <input
                type="text"
                id="enlistment_date_custom"
                name="enlistment_date_custom"
                class="form-control mt-2"
                placeholder="дд.мм.рррр"
                pattern="\d{2}\.\d{2}\.\d{4}"
                title="Введіть дату у форматі дд.мм.рррр"
                style="display: none"
              />
            </div>

            <!-- Під медичним наглядом -->
            <div class="mb-3">
              <label for="observation_end" class="form-label">
                <i class="fas fa-stethoscope me-1"></i>Під медичним наглядом по
              </label>
              <select
                id="observation_end"
                name="observation_end"
                class="form-select"
                required
                onchange="toggleObservationEndCustomDate()"
              >
                <option value="">Оберіть варіант</option>
                <option value="по теперішній час">По теперішній час</option>
                <option value="custom">Вказати конкретну дату</option>
              </select>
              <input
                type="text"
                id="observation_end_custom"
                name="observation_end_custom"
                class="form-control mt-2"
                placeholder="дд.мм.рррр"
                pattern="\d{2}\.\d{2}\.\d{4}"
                title="Введіть дату у форматі дд.мм.рррр"
                style="display: none"
              />
            </div>

            <hr />
            <div class="alert alert-info text-center">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Заповнюйте, якщо військового немає в таблиці</strong>
            </div>

            <!-- Додаткові поля -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="zvanie" class="form-label">
                    <i class="fas fa-shield-alt me-1"></i>Військове звання
                  </label>
                  <select id="zvanie" name="zvanie" class="form-select">
                    <option value="">Оберіть звання</option>
                    <option value="солдат">солдат</option>
                    <option value="старший солдат">старший солдат</option>
                    <option value="молодший сержант">молодший сержант</option>
                    <option value="сержант">сержант</option>
                    <option value="старший сержант">старший сержант</option>
                    <option value="головний сержант">головний сержант</option>
                    <option value="штаб-сержант">штаб-сержант</option>
                    <option value="майстер-сержант">майстер-сержант</option>
                    <option value="старший майстер-сержант">
                      старший майстер-сержант
                    </option>
                    <option value="головний майстер-сержант">
                      головний майстер-сержант
                    </option>
                    <option value="молодший лейтенант">
                      молодший лейтенант
                    </option>
                    <option value="лейтенант">лейтенант</option>
                    <option value="старший лейтенант">старший лейтенант</option>
                    <option value="капітан">капітан</option>
                    <option value="майор">майор</option>
                    <option value="підполковник">підполковник</option>
                    <option value="полковник">полковник</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="sluzhba_type" class="form-label">
                    <i class="fas fa-clipboard-list me-1"></i>Вид служби
                  </label>
                  <select
                    id="sluzhba_type"
                    name="sluzhba_type"
                    class="form-select"
                  >
                    <option value="під час мобілізації">
                      під час мобілізації
                    </option>
                    <option value="за контрактом">за контрактом</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="birth_date" class="form-label">
                <i class="fas fa-birthday-cake me-1"></i>Дата народження
                (дд.мм.рррр)
              </label>
              <input
                type="text"
                id="birth_date"
                name="birth_date"
                class="form-control"
                placeholder="дд.мм.рррр"
                pattern="\d{2}\.\d{2}\.\d{4}"
                title="Введіть дату у форматі дд.мм.рррр"
              />
            </div>

            <div class="mb-3">
              <label for="signatory" class="form-label">
                <i class="fas fa-signature me-1"></i>Підписує характеристику
              </label>
              <select
                id="signatory"
                name="signatory"
                class="form-select"
                required
              >
                <option value="">Оберіть підписанта</option>
                <option value="acting_chief">
                  Т. в. о. начальника медичної служби секції тилу капітан м\с
                  Ірина ГОНЧАРОВА
                </option>
                <option value="chief">
                  Начальник медичної служби секції тилу капітан м\с Юлія ЮРЧАК
                </option>
                <option value="company_commander">
                  Командир медичної роти капітан м/с Євгеній МАЖАЄВ
                </option>
              </select>
            </div>

            <div class="mb-3 form-check">
              <input
                type="checkbox"
                id="no_diagnosis"
                name="no_diagnosis"
                value="yes"
                class="form-check-input"
              />
              <label for="no_diagnosis" class="form-check-label">
                <i class="fas fa-exclamation-triangle me-1"></i>
                Для службового розслідування (без діагнозів)
              </label>
            </div>

            <div class="d-grid">
              <button
                id="submit-button"
                type="submit"
                class="btn btn-primary btn-lg"
              >
                <i class="fas fa-file-medical me-2"></i>
                Створити медичну характеристику
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_css %}
<style>
  .autocomplete-container {
    position: relative;
  }

  .autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ced4da;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    border-radius: 0 0 0.375rem 0.375rem;
  }

  .autocomplete-suggestion {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #dee2e6;
  }

  .autocomplete-suggestion:hover,
  .autocomplete-suggestion.selected {
    background-color: #f8f9fa;
  }

  .autocomplete-suggestion:last-child {
    border-bottom: none;
  }
</style>
{% endblock %} {% block extra_js %}
<script>
  const form = document.getElementById("generation-form");
  const submitButton = document.getElementById("submit-button");
  const pibNazivnyi = document.getElementById("pib_nazivnyi");
  const pibRodovyi = document.getElementById("pib_rodovyi");
  const pibSuggestions = document.getElementById("pib-suggestions");

  let currentSuggestions = [];
  let selectedIndex = -1;

  // Завантаження статистики бази даних
  async function loadDatabaseStats() {
    try {
      const response = await fetch("/api/stats");
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const stats = await response.json();
      if (stats.error) {
        document.getElementById("stats-text").textContent =
          "Помилка завантаження";
        return;
      }
      const totalRecords = stats.total_records ?? stats.total_treatments ?? 0;
      const uniquePatients = stats.unique_patients ?? stats.total_patients ?? 0;
      document.getElementById(
        "stats-text"
      ).textContent = `${totalRecords} записів, ${uniquePatients} унікальних пацієнтів`;
    } catch (error) {
      console.error("Помилка при завантаженні статистики:", error);
      document.getElementById("stats-text").textContent =
        "Помилка завантаження";
    }
  }

  // Завантажуємо статистику при завантаженні сторінки
  document.addEventListener("DOMContentLoaded", loadDatabaseStats);

  function getCookie(name) {
    let a = `; ${document.cookie}`.match(`;\\s*${name}=([^;]+)`);
    return a ? a[1] : "";
  }

  // Функція для пошуку ПІБ
  async function searchPIB(query) {
    if (query.length < 2) {
      hideSuggestions();
      return;
    }

    try {
      const response = await fetch(
        `/api/search_pib?q=${encodeURIComponent(query)}`
      );
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      if (data.results && data.results.length > 0) {
        showSuggestions(data.results);
      } else {
        hideSuggestions();
      }
    } catch (error) {
      console.error("Помилка при пошуку ПІБ:", error);
      hideSuggestions();
    }
  }

  // Показати пропозиції
  function showSuggestions(suggestions) {
    currentSuggestions = suggestions;
    selectedIndex = -1;
    pibSuggestions.innerHTML = "";

    suggestions.forEach((suggestion, index) => {
      const div = document.createElement("div");
      div.className = "autocomplete-suggestion";
      div.textContent = suggestion.label;
      div.dataset.value = suggestion.value;
      div.dataset.index = index;

      div.addEventListener("click", function () {
        selectSuggestion(suggestion);
      });

      pibSuggestions.appendChild(div);
    });

    pibSuggestions.style.display = "block";
  }

  // Приховати пропозиції
  function hideSuggestions() {
    pibSuggestions.style.display = "none";
    currentSuggestions = [];
    selectedIndex = -1;
  }

  // Вибрати пропозицію
  function selectSuggestion(suggestion) {
    const value =
      typeof suggestion === "string" ? suggestion : suggestion.value;
    const data = typeof suggestion === "object" ? suggestion : null;

    pibNazivnyi.value = value;
    pibRodovyi.value = "";

    // Автозаповнення звання якщо є дані
    if (data && data.rank) {
      const rankSelect = document.getElementById("zvanie");
      if (rankSelect) {
        for (let option of rankSelect.options) {
          if (option.value.toLowerCase() === data.rank.toLowerCase()) {
            rankSelect.value = option.value;
            break;
          }
        }
      }
    }

    // Автозаповнення дати народження якщо є дані
    if (data && data.birth_date) {
      const birthDateInput = document.getElementById("birth_date");
      if (birthDateInput && !birthDateInput.value) {
        const v = String(data.birth_date).trim();
        // Підтримуємо формати YYYY-MM-DD або DD.MM.YYYY
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
          const [y, m, d] = v.split("-");
          birthDateInput.value = `${d}.${m}.${y}`;
        } else if (/^\d{2}\.\d{2}\.\d{4}$/.test(v)) {
          birthDateInput.value = v;
        }
      }
    }

    // Автозаповнення ПІБ у родовому відмінку (просте копіювання як базовий варіант)
    if (data && data.value) {
      const rodInput = document.getElementById("pib_rodovyi");
      if (rodInput && !rodInput.value) {
        rodInput.value = data.value;
      }
    }

    hideSuggestions();
  }

  // Обробка клавіш для навігації
  function handleKeyNavigation(e) {
    if (pibSuggestions.style.display === "none") return;

    const suggestions = pibSuggestions.querySelectorAll(
      ".autocomplete-suggestion"
    );

    switch (e.key) {
      case "ArrowDown":
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
        updateSelection(suggestions);
        break;
      case "ArrowUp":
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection(suggestions);
        break;
      case "Enter":
        e.preventDefault();
        if (selectedIndex >= 0 && suggestions[selectedIndex]) {
          const suggestionData = currentSuggestions[selectedIndex];
          selectSuggestion(suggestionData);
        }
        break;
      case "Escape":
        hideSuggestions();
        break;
    }
  }

  // Оновити виділення
  function updateSelection(suggestions) {
    suggestions.forEach((suggestion, index) => {
      suggestion.classList.toggle("selected", index === selectedIndex);
    });
  }

  // Валідація дати
  function validateDate(dateString) {
    const pattern = /^(\d{2})\.(\d{2})\.(\d{4})$/;
    const match = dateString.match(pattern);
    if (!match) return false;

    const day = parseInt(match[1], 10);
    const month = parseInt(match[2], 10);
    const year = parseInt(match[3], 10);

    if (month < 1 || month > 12) return false;
    if (day < 1 || day > 31) return false;
    if (year < 1900 || year > new Date().getFullYear()) return false;

    const date = new Date(year, month - 1, day);
    return (
      date.getDate() === day &&
      date.getMonth() === month - 1 &&
      date.getFullYear() === year
    );
  }

  // Автозаповнення родового відмінку та пошук ПІБ
  let searchTimeout;

  pibNazivnyi.addEventListener("input", function () {
    pibRodovyi.value = "";
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchPIB(pibNazivnyi.value);
    }, 300);
  });

  pibNazivnyi.addEventListener("keydown", handleKeyNavigation);

  // Приховати пропозиції при кліку поза полем
  document.addEventListener("click", function (e) {
    if (!pibNazivnyi.contains(e.target) && !pibSuggestions.contains(e.target)) {
      hideSuggestions();
    }
  });

  // Валідація полів
  document
    .getElementById("enlistment_date")
    .addEventListener("change", function () {
      if (!this.value) {
        this.setCustomValidity("Оберіть варіант дати призову");
      } else if (
        this.value === "з моменту призову" ||
        this.value === "custom"
      ) {
        this.setCustomValidity("");
      } else {
        this.setCustomValidity("Оберіть валідний варіант");
      }
    });

  document.getElementById("birth_date").addEventListener("blur", function () {
    if (this.value && !validateDate(this.value)) {
      this.setCustomValidity("Введіть коректну дату у форматі дд.мм.рррр");
    } else {
      this.setCustomValidity("");
    }
  });

  document
    .getElementById("enlistment_date_custom")
    .addEventListener("blur", function () {
      if (this.value && !validateDate(this.value)) {
        this.setCustomValidity("Введіть коректну дату у форматі дд.мм.рррр");
      } else {
        this.setCustomValidity("");
      }
    });

  document
    .getElementById("observation_end_custom")
    .addEventListener("blur", function () {
      if (this.value && !validateDate(this.value)) {
        this.setCustomValidity("Введіть коректну дату у форматі дд.мм.рррр");
      } else {
        this.setCustomValidity("");
      }
    });

  form.addEventListener("submit", function () {
    const enlistmentSelect = document.getElementById("enlistment_date");
    const customInput = document.getElementById("enlistment_date_custom");

    if (enlistmentSelect.value === "custom" && !customInput.value) {
      customInput.setCustomValidity("Вкажіть конкретну дату");
      customInput.reportValidity();
      return false;
    }

    const observationSelect = document.getElementById("observation_end");
    const observationCustom = document.getElementById("observation_end_custom");
    if (observationSelect.value === "custom" && !observationCustom.value) {
      observationCustom.setCustomValidity("Вкажіть конкретну дату");
      observationCustom.reportValidity();
      return false;
    }

    if (form.checkValidity()) {
      showLoading();
      submitButton.disabled = true;

      let cookieCheck = setInterval(function () {
        if (getCookie("fileDownload") === "true") {
          clearInterval(cookieCheck);
          hideLoading();
          submitButton.disabled = false;
          document.cookie =
            "fileDownload=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        }
      }, 500);
    }
  });

  // Ініціалізація валідації при завантаженні сторінки
  document.addEventListener("DOMContentLoaded", function () {
    const enlistmentSelect = document.getElementById("enlistment_date");
    if (enlistmentSelect.value) {
      toggleCustomDate();
    }
    const observationSelect = document.getElementById("observation_end");
    if (observationSelect.value) {
      toggleObservationEndCustomDate();
    }
  });

  // Функція для перемикання між варіантами дати призову
  function toggleCustomDate() {
    const select = document.getElementById("enlistment_date");
    const customInput = document.getElementById("enlistment_date_custom");

    if (select.value === "custom") {
      customInput.style.display = "block";
      customInput.required = true;
      select.setCustomValidity("");
    } else {
      customInput.style.display = "none";
      customInput.required = false;
      customInput.value = "";
      customInput.setCustomValidity("");
      if (!select.value) {
        select.setCustomValidity("Оберіть варіант дати призову");
      } else if (
        select.value === "з моменту призову" ||
        select.value === "custom"
      ) {
        select.setCustomValidity("");
      } else {
        select.setCustomValidity("Оберіть валідний варіант");
      }
    }
  }

  // Перемикання між варіантами завершення нагляду
  function toggleObservationEndCustomDate() {
    const select = document.getElementById("observation_end");
    const customInput = document.getElementById("observation_end_custom");

    if (select.value === "custom") {
      customInput.style.display = "block";
      customInput.required = true;
      select.setCustomValidity("");
    } else {
      customInput.style.display = "none";
      customInput.required = false;
      customInput.value = "";
      customInput.setCustomValidity("");
      if (!select.value) {
        select.setCustomValidity("Оберіть варіант дати");
      } else if (
        select.value === "по теперішній час" ||
        select.value === "custom"
      ) {
        select.setCustomValidity("");
      } else {
        select.setCustomValidity("Оберіть валідний варіант");
      }
    }
  }
</script>
{% endblock %}
