{% extends "base.html" %}
{% block title %}Неоплачені стаціонари - МедХар{% endblock %}
{% block extra_css %}
    <style>
      .loading {
        display: none;
      }
      .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .unpaid-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
      }
      .epicrisis-badge {
        background-color: #ff6b6b;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
      }
      .table th {
        background-color: #f8f9fa;
        border-top: none;
      }
      .btn-generate {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
      }
      .btn-generate:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
      }
    </style>
{% endblock %}
{% block content %}
    <div class="container mt-4">
      <div class="row">
        <div class="col-12">
          <h2 class="mb-4">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            Неоплачені стаціонарні лікування
          </h2>

          <!-- Форма фільтрів -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Фільтри та генерація звіту
              </h5>
            </div>
            <div class="card-body">
              <form id="filterForm">
                <div class="row">
                  <div class="col-md-2">
                    <label for="filterType" class="form-label"
                      >Тип фільтру</label
                    >
                    <select
                      class="form-select"
                      id="filterType"
                      name="filterType"
                      onchange="toggleFilterType()"
                    >
                      <option value="single">Один місяць</option>
                      <option value="range">Діапазон місяців</option>
                    </select>
                  </div>
                  <div class="col-md-2" id="monthSelect">
                    <label for="month" class="form-label">Місяць</label>
                    <select class="form-select" id="month" name="month">
                      <option value="">Всі місяці</option>
                      <option value="1">Січень</option>
                      <option value="2">Лютий</option>
                      <option value="3">Березень</option>
                      <option value="4">Квітень</option>
                      <option value="5">Травень</option>
                      <option value="6">Червень</option>
                      <option value="7">Липень</option>
                      <option value="8">Серпень</option>
                      <option value="9">Вересень</option>
                      <option value="10">Жовтень</option>
                      <option value="11">Листопад</option>
                      <option value="12">Грудень</option>
                    </select>
                  </div>
                  <div
                    class="col-md-2"
                    id="startMonthSelect"
                    style="display: none"
                  >
                    <label for="startMonth" class="form-label">З місяця</label>
                    <select
                      class="form-select"
                      id="startMonth"
                      name="startMonth"
                    >
                      <option value="1">Січень</option>
                      <option value="2">Лютий</option>
                      <option value="3">Березень</option>
                      <option value="4">Квітень</option>
                      <option value="5">Травень</option>
                      <option value="6">Червень</option>
                      <option value="7">Липень</option>
                      <option value="8">Серпень</option>
                      <option value="9" selected>Вересень</option>
                      <option value="10">Жовтень</option>
                      <option value="11">Листопад</option>
                      <option value="12">Грудень</option>
                    </select>
                  </div>
                  <div
                    class="col-md-2"
                    id="endMonthSelect"
                    style="display: none"
                  >
                    <label for="endMonth" class="form-label">По місяць</label>
                    <select class="form-select" id="endMonth" name="endMonth">
                      <option value="1">Січень</option>
                      <option value="2">Лютий</option>
                      <option value="3">Березень</option>
                      <option value="4">Квітень</option>
                      <option value="5">Травень</option>
                      <option value="6">Червень</option>
                      <option value="7">Липень</option>
                      <option value="8">Серпень</option>
                      <option value="9" selected>Вересень</option>
                      <option value="10">Жовтень</option>
                      <option value="11">Листопад</option>
                      <option value="12">Грудень</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label for="year" class="form-label">Рік</label>
                    <select class="form-select" id="year" name="year">
                      <option value="">Всі роки</option>
                      <option value="2024">2024</option>
                      <option value="2025" selected>2025</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label for="unit" class="form-label">Підрозділ</label>
                    <select class="form-select" id="unit" name="unit">
                      <option value="2 БОП" selected>2 БОП</option>
                      <option value="6 БОП">6 БОП</option>
                      <option value="">Всі підрозділи</option>
                    </select>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12">
                    <button
                      type="button"
                      class="btn btn-primary me-2"
                      id="loadData"
                    >
                      <i class="fas fa-search me-1"></i>Завантажити
                    </button>
                    <button
                      type="button"
                      class="btn btn-generate"
                      id="generateExcel"
                    >
                      <i class="fas fa-file-excel me-1"></i>Excel
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Статистика -->
          <div id="summarySection" class="row mb-4" style="display: none">
            <div class="col-md-3">
              <div class="card summary-card">
                <div class="card-body text-center">
                  <h3 id="totalUnpaid">0</h3>
                  <p class="mb-0">Пацієнтів з неоплаченими стаціонарами</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card summary-card">
                <div class="card-body text-center">
                  <h3 id="totalDays">0</h3>
                  <p class="mb-0">Днів лікування</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card summary-card">
                <div class="card-body text-center">
                  <h3 id="totalAmount">0 грн</h3>
                  <p class="mb-0">Загальна сума</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card unpaid-card">
                <div class="card-body text-center">
                  <h3 id="epicrisisCount">0</h3>
                  <p class="mb-0">Потребують епікризу</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Таблиця результатів -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>Список неоплачених стаціонарних
                лікувань
              </h5>
            </div>
            <div class="card-body">
              <div
                id="loadingIndicator"
                class="text-center"
                style="display: none"
              >
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Завантаження...</span>
                </div>
                <p class="mt-2">Завантаження даних...</p>
              </div>

              <div id="resultsTable" style="display: none">
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>ПІБ</th>
                        <th>Звання</th>
                        <th>Підрозділ</th>
                        <th>Дата первинної госпіталізації</th>
                        <th>Дати надходження в стаціонари</th>
                        <th>Дати виписки</th>
                        <th>Назви стаціонарів</th>
                        <th>Діагноз</th>
                        <th>Причина бойовості</th>
                        <th>Статус</th>
                      </tr>
                    </thead>
                    <tbody id="treatmentsTableBody"></tbody>
                  </table>
                </div>
              </div>

              <div
                id="noResults"
                class="text-center text-muted"
                style="display: none"
              >
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <h5>Відмінно!</h5>
                <p>Неоплачених стаціонарних лікувань не знайдено.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

{% endblock %}
{% block extra_js %}
    <script>
      // Функція для форматування дати
      function formatDate(dateStr) {
        if (!dateStr) return "Н/Д";
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString("uk-UA");
        } catch (e) {
          return dateStr;
        }
      }

      // Функція для форматування суми
      function formatAmount(amount) {
        return new Intl.NumberFormat("uk-UA").format(amount) + " грн";
      }

      // Функція перемикання типу фільтру
      function toggleFilterType() {
        const filterType = document.getElementById("filterType").value;
        const monthSelect = document.getElementById("monthSelect");
        const startMonthSelect = document.getElementById("startMonthSelect");
        const endMonthSelect = document.getElementById("endMonthSelect");

        if (filterType === "range") {
          monthSelect.style.display = "none";
          startMonthSelect.style.display = "block";
          endMonthSelect.style.display = "block";
        } else {
          monthSelect.style.display = "block";
          startMonthSelect.style.display = "none";
          endMonthSelect.style.display = "none";
        }
      }

      // Завантаження даних
      async function loadUnpaidTreatments() {
        const filterType = document.getElementById("filterType").value;
        const month = document.getElementById("month").value;
        const startMonth = document.getElementById("startMonth").value;
        const endMonth = document.getElementById("endMonth").value;
        const year = document.getElementById("year").value;
        const unit = document.getElementById("unit").value;

        const loadingIndicator = document.getElementById("loadingIndicator");
        const resultsTable = document.getElementById("resultsTable");
        const noResults = document.getElementById("noResults");
        const summarySection = document.getElementById("summarySection");

        loadingIndicator.style.display = "block";
        resultsTable.style.display = "none";
        noResults.style.display = "none";
        summarySection.style.display = "none";

        try {
          const params = new URLSearchParams();
          if (filterType === "range" && startMonth && endMonth) {
            params.append("start_month", startMonth);
            params.append("end_month", endMonth);
          } else if (month) {
            params.append("month", month);
          }
          if (year) params.append("year", year);
          if (unit) params.append("unit", unit);

          const response = await fetch(
            `/api/unpaid_stationary_treatments?${params}`
          );
          const data = await response.json();

          console.log("Отримані дані:", data); // Додаємо логування

          if (data.error) {
            alert("Помилка: " + data.error);
            return;
          }

          // Оновлюємо статистику
          document.getElementById("totalUnpaid").textContent =
            data.total_patients || 0;
          document.getElementById("totalDays").textContent =
            data.total_days || 0;
          document.getElementById("totalAmount").textContent = formatAmount(
            data.total_amount || 0
          );

          // Підраховуємо потребують епікризу (пацієнти з проміжним епікризом)
          const epicrisisCount = data.patients
            ? data.patients.filter(
                (p) =>
                  p["Unnamed: 7"] &&
                  p["Unnamed: 7"].includes("Проміжний епікриз")
              ).length
            : 0;
          document.getElementById("epicrisisCount").textContent =
            epicrisisCount;

          summarySection.style.display = "flex";

          // Заповнюємо таблицю
          const tbody = document.getElementById("treatmentsTableBody");
          tbody.innerHTML = "";

          if (!data.patients || data.patients.length === 0) {
            noResults.style.display = "block";
          } else {
            data.patients.forEach((patient) => {
              const row = document.createElement("tr");

              // Форматуємо дати та назви стаціонарів для відображення
              const startDates = patient["Дати загал"]
                ? String(patient["Дати загал"]).split("\n").join(", ")
                : "Н/Д";
              const endDates = patient["Unnamed: 7"]
                ? String(patient["Unnamed: 7"]).split("\n").join(", ")
                : "Н/Д";
              const hospitalNames = patient["Назви стаціонарів"]
                ? String(patient["Назви стаціонарів"]).split("\n").join(", ")
                : "Н/Д";

              // Перевіряємо чи є проміжний епікриз
              const hasEpicrisis =
                patient["Unnamed: 7"] &&
                patient["Unnamed: 7"].includes("Проміжний епікриз");

              row.innerHTML = `
                            <td>${patient["ПІБ"] || "Н/Д"}</td>
                            <td>${patient["Військове звання"] || "Н/Д"}</td>
                            <td>${patient["Підрозділ"] || "Н/Д"}</td>
                            <td>${
                              patient["Дата первинної госпіталізації"] || "Н/Д"
                            }</td>
                            <td>${startDates}</td>
                            <td>${endDates}</td>
                            <td>${hospitalNames}</td>
                            <td>${
                              patient["Діагноз"]
                                ? String(patient["Діагноз"]).substring(0, 50) +
                                  "..."
                                : "Н/Д"
                            }</td>
                            <td>Бойовий діагноз</td>
                            <td>
                                ${
                                  hasEpicrisis
                                    ? '<span class="badge bg-warning">Потребує епікризу</span>'
                                    : '<span class="badge bg-danger">Неоплачено</span>'
                                }
                            </td>
                        `;
              tbody.appendChild(row);
            });
            resultsTable.style.display = "block";
          }
        } catch (error) {
          console.error("Помилка завантаження даних:", error);
          console.error("Стек помилки:", error.stack);
          alert("Помилка завантаження даних: " + error.message);
        } finally {
          loadingIndicator.style.display = "none";
        }
      }

      // Генерація Excel
      async function generateExcel() {
        const filterType = document.getElementById("filterType").value;
        const month = document.getElementById("month").value;
        const startMonth = document.getElementById("startMonth").value;
        const endMonth = document.getElementById("endMonth").value;
        const year = document.getElementById("year").value;
        const unit = document.getElementById("unit").value;

        const generateBtn = document.getElementById("generateExcel");
        const originalText = generateBtn.innerHTML;

        generateBtn.disabled = true;
        generateBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin me-1"></i>Генерація...';

        try {
          const requestData = {
            year: year ? parseInt(year) : null,
            unit: unit || "2 БОП",
          };

          if (filterType === "range" && startMonth && endMonth) {
            requestData.start_month = parseInt(startMonth);
            requestData.end_month = parseInt(endMonth);
          } else if (month) {
            requestData.month = parseInt(month);
          }

          const response = await fetch("/api/generate_unpaid_excel", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `неоплачені_стаціонари_${
              new Date().toISOString().split("T")[0]
            }.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else {
            const error = await response.json();
            alert("Помилка генерації Excel: " + error.error);
          }
        } catch (error) {
          console.error("Помилка генерації Excel:", error);
          alert("Помилка генерації Excel: " + error.message);
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = originalText;
        }
      }

      // Обробники подій
      document
        .getElementById("loadData")
        .addEventListener("click", loadUnpaidTreatments);
      document
        .getElementById("generateExcel")
        .addEventListener("click", generateExcel);

      // Автоматичне завантаження при завантаженні сторінки
      document.addEventListener("DOMContentLoaded", function () {
        loadUnpaidTreatments();
      });
    </script>
{% endblock %}
